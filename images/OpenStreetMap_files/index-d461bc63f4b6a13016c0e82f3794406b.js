function initializeBrowse(t){function e(){var e=t.getBounds();i&&i.contains(e)||a()}function o(t,e,o,a){$("#browse_status").html($("<p class='warning'></p>").text(I18n.t("browse.start_rjs.feature_warning",{num_features:t,max_features:e})).prepend($("<span class='icon close'></span>").click(a)).append($("<input type='submit'>").val(I18n.t("browse.start_rjs.load_data")).click(o)))}function a(){var e=t.getBounds(),a="/api/"+OSM.API_VERSION+"/map?bbox="+e.toBBoxString(),n=2e3;l&&l.abort(),l=$.ajax({url:a,success:function(t){function a(){$("#browse_status").empty(),s.addData(d),i=e}function c(){$("#browse_status").empty()}s.clearLayers(),r=null;var d=s.buildFeatures(t);d.length<n?a():o(d.length,n,a,c),l=null}})}function n(t){r&&r.setStyle(r.originalStyle),t.originalStyle=t.options,t.setStyle({color:"#0000ff",weight:8}),OSM.router.route("/"+t.feature.type+"/"+t.feature.id),r=t}var i,r,s=t.dataLayer;s.setStyle({way:{weight:3,color:"#000000",opacity:.4},area:{weight:3,color:"#ff0000"},node:{color:"#00ff00"}}),s.isWayArea=function(){return!1},s.on("click",function(t){n(t.layer)}),t.on("layeradd",function(o){o.layer===s&&(t.on("moveend",e),e())}),t.on("layerremove",function(o){o.layer===s&&(t.off("moveend",e),$("#browse_status").empty())});var l}function initializeNotes(t){function e(t,e){return t?t.setIcon(i[e.properties.status]):(t=L.marker(e.geometry.coordinates.reverse(),{icon:i[e.properties.status],opacity:.8,clickable:!0}),t.id=e.properties.id,t.addTo(a)),t}function o(){function o(t){function o(t){var o=i[t.properties.id];delete i[t.properties.id],n[t.properties.id]=e(o,t)}var i=n;n={},t.features.forEach(o);for(var s in i)a.removeLayer(i[s]);r=null}var i=t.getBounds(),s=i.getSize();if(s<=OSM.MAX_NOTE_REQUEST_AREA){var l="/api/"+OSM.API_VERSION+"/notes.json?bbox="+i.toBBoxString();r&&r.abort(),r=$.ajax({url:l,success:o})}}var a=t.noteLayer,n={},i={"new":L.icon({iconUrl:"/assets/new_note_marker-f288a218f297b58fa66b991944736848.png",iconSize:[25,40],iconAnchor:[12,40]}),open:L.icon({iconUrl:"/assets/open_note_marker-d4c52755bf53d8cac761620aebaee4b4.png",iconSize:[25,40],iconAnchor:[12,40]}),closed:L.icon({iconUrl:"/assets/closed_note_marker-90bceb5b3498278726d1608c306c2d0f.png",iconSize:[25,40],iconAnchor:[12,40]})};t.on("layeradd",function(e){e.layer==a&&(o(),t.on("moveend",o))}).on("layerremove",function(e){e.layer==a&&(t.off("moveend",o),a.clearLayers(),n={})}),a.on("click",function(t){t.layer.id&&OSM.router.route("/note/"+t.layer.id)}),a.getLayerId=function(t){return t.id};var r}!function(){var t;OSM.loadSidebarContent=function(e,o){clearTimeout(t),t=setTimeout(function(){$("#sidebar_loader").show()},200),e+=e.indexOf("?")>=0?"&xhr=1":"?xhr=1",$("#sidebar_content").empty(),$.ajax({url:e,dataType:"html",complete:function(e){clearTimeout(t),$("#flash").empty(),$("#sidebar_loader").hide();var a=$(e.responseText);if(e.getResponseHeader("X-Page-Title")){var n=e.getResponseHeader("X-Page-Title");document.title=decodeURIComponent(escape(n))}$("head").find('link[type="application/atom+xml"]').remove(),$("head").append(a.filter('link[type="application/atom+xml"]')),$("#sidebar_content").html(a.not('link[type="application/atom+xml"]')),o&&o()}})}}(),$(document).ready(function(){var t=OSM.mapParams(),e=new L.OSM.Map("map",{zoomControl:!1,layerControl:!1});e.attributionControl.setPrefix(""),e.updateLayers(t.layers),e.on("baselayerchange",function(t){e.getZoom()>t.layer.options.maxZoom&&e.setView(e.getCenter(),t.layer.options.maxZoom,{reset:!0})});var o="rtl"===$("html").attr("dir")?"topleft":"topright";L.OSM.zoom({position:o}).addTo(e),L.control.locate({position:o,strings:{title:I18n.t("javascripts.map.locate.title"),popup:I18n.t("javascripts.map.locate.popup")}}).addTo(e);var a=L.OSM.sidebar("#map-ui").addTo(e);L.OSM.layers({position:o,layers:e.baseLayers,sidebar:a}).addTo(e),L.OSM.key({position:o,sidebar:a}).addTo(e),L.OSM.share({position:o,sidebar:a,"short":!0}).addTo(e),L.OSM.note({position:o,sidebar:a}).addTo(e),L.OSM.query({position:o,sidebar:a}).addTo(e),L.control.scale().addTo(e),"api_offline"!=OSM.STATUS&&"database_offline"!=OSM.STATUS&&(initializeNotes(e),t.layers.indexOf(e.noteLayer.options.code)>=0&&e.addLayer(e.noteLayer),initializeBrowse(e),t.layers.indexOf(e.dataLayer.options.code)>=0&&e.addLayer(e.dataLayer)),$(".leaflet-control .control-button").tooltip({placement:"left",container:"body"});var n=new Date;n.setYear(n.getFullYear()+10),e.on("moveend layeradd layerremove",function(){updateLinks(e.getCenter().wrap(),e.getZoom(),e.getLayersCode(),e._object),$.removeCookie("_osm_location"),$.cookie("_osm_location",OSM.locationCookie(e),{expires:n,path:"/"})}),"hide"==$.cookie("_osm_sotm")&&$("#sotm").hide(),$("#sotm .close").on("click",function(){$("#sotm").hide(),$.cookie("_osm_sotm","hide",{expires:n})}),"hide"==$.cookie("_osm_welcome")&&$(".welcome").hide(),$(".welcome .close").on("click",function(){$(".welcome").hide(),$.cookie("_osm_welcome","hide",{expires:n})}),OSM.PIWIK&&e.on("layeradd",function(t){if(t.layer.options){var e=OSM.PIWIK.goals[t.layer.options.keyid];e&&$("body").trigger("piwikgoal",e)}}),t.bounds?e.fitBounds(t.bounds):e.setView([t.lat,t.lon],t.zoom);var i=L.marker([0,0],{icon:getUserIcon()});t.marker&&i.setLatLng([t.mlat,t.mlon]).addTo(e),$("#homeanchor").on("click",function(t){t.preventDefault();var o=$(this).data(),a=L.latLng(o.lat,o.lon);e.setView(a,o.zoom),i.setLatLng(a).addTo(e)}),$("a[data-editor=remote]").click(function(t){var o=OSM.mapParams(this.search);remoteEditHandler(e.getBounds(),o.object),t.preventDefault()}),OSM.params().edit_help&&($("#editanchor").removeAttr("title").tooltip({placement:"bottom",title:I18n.t("javascripts.edit_help")}).tooltip("show"),$("body").one("click",function(){$("#editanchor").tooltip("hide")})),OSM.Index=function(t){var e={};return e.pushstate=function(){$("#content").addClass("overlay-sidebar"),t.invalidateSize({pan:!1}).panBy([-350,0],{animate:!1}),document.title=I18n.t("layouts.project_name.title")},e.load=function(){return"autofocus"in document.createElement("input")||$("#sidebar .search_form input[name=query]").focus(),t.getState()},e.popstate=function(){$("#content").addClass("overlay-sidebar"),t.invalidateSize({pan:!1}),document.title=I18n.t("layouts.project_name.title")},e.unload=function(){t.panBy([350,0],{animate:!1}),$("#content").removeClass("overlay-sidebar"),t.invalidateSize({pan:!1})},e},OSM.Browse=function(t,e){function o(e,o,a){t.addObject({type:e,id:parseInt(o)},function(e){window.location.hash||!e.isValid()||!a&&t.getBounds().contains(e)||OSM.router.withoutMoveListener(function(){t.fitBounds(e)})})}var a={};return a.pushstate=a.popstate=function(t,a){OSM.loadSidebarContent(t,function(){o(e,a)})},a.load=function(t,a){o(e,a,!0)},a.unload=function(){t.removeObject()},a};var r=OSM.History(e);OSM.router=OSM.Router(e,{"/":OSM.Index(e),"/search":OSM.Search(e),"/export":OSM.Export(e),"/note/new":OSM.NewNote(e),"/history/friends":r,"/history/nearby":r,"/history":r,"/user/:display_name/history":r,"/note/:id":OSM.Note(e),"/node/:id(/history)":OSM.Browse(e,"node"),"/way/:id(/history)":OSM.Browse(e,"way"),"/relation/:id(/history)":OSM.Browse(e,"relation"),"/changeset/:id":OSM.Changeset(e),"/query":OSM.Query(e)}),"remote"==OSM.preferred_editor&&"/edit"==document.location.pathname&&(remoteEditHandler(e.getBounds(),t.object),OSM.router.setCurrentPath("/")),OSM.router.load(),$(document).on("click","a",function(t){t.isDefaultPrevented()||t.isPropagationStopped()||t.which>1||t.metaKey||t.ctrlKey||t.shiftKey||t.altKey||location.protocol===this.protocol&&location.host===this.host&&OSM.router.route(this.pathname+this.search+this.hash)&&t.preventDefault()}),$(".search_form").on("submit",function(t){t.preventDefault(),$("header").addClass("closed");var o=$(this).find("input[name=query]").val();OSM.router.route(o?"/search?query="+encodeURIComponent(o)+OSM.formatHash(e):"/")}),$(".describe_location").on("click",function(t){t.preventDefault();var o=e.getCenter().wrap(),a=OSM.zoomPrecision(e.getZoom());OSM.router.route("/search?query="+encodeURIComponent(o.lat.toFixed(a)+","+o.lng.toFixed(a)))})}),L.OSM.sidebar=function(t){var e,o={},a=$(t),n=$(),i=$();return o.addTo=function(t){return e=t,o},o.addPane=function(t){t.hide().appendTo(a)},o.togglePane=function(t,o){n.hide().trigger("hide"),i.removeClass("active"),n===t?($(a).hide(),n=i=$()):($(a).show(),n=t,i=o||$()),e.invalidateSize({pan:!1,animate:!1}),n.show().trigger("show"),i.addClass("active")},o},L.Control.Locate=L.Control.extend({options:{position:"topleft",drawCircle:!0,follow:!1,stopFollowingOnDrag:!1,circleStyle:{color:"#136AEC",fillColor:"#136AEC",fillOpacity:.15,weight:2,opacity:.5},markerStyle:{color:"#136AEC",fillColor:"#2A93EE",fillOpacity:.7,weight:2,opacity:.9,radius:5},followCircleStyle:{},followMarkerStyle:{},icon:"icon-location",iconLoading:"icon-spinner animate-spin",circlePadding:[0,0],metric:!0,onLocationError:function(t){alert(t.message)},onLocationOutsideMapBounds:function(t){t.stopLocate(),alert(context.options.strings.outsideMapBoundsMsg)},setView:!0,keepCurrentZoomLevel:!1,strings:{title:"Show me where I am",popup:"You are within {distance} {unit} from this point",outsideMapBoundsMsg:"You seem located outside the boundaries of the map"},locateOptions:{maxZoom:1/0,watch:!0}},onAdd:function(t){var e=L.DomUtil.create("div","control-locate"),o=this;this._layer=new L.LayerGroup,this._layer.addTo(t),this._event=void 0,this._locateOptions=this.options.locateOptions,L.extend(this._locateOptions,this.options.locateOptions),L.extend(this._locateOptions,{setView:!1});var a={};L.extend(a,this.options.markerStyle,this.options.followMarkerStyle),this.options.followMarkerStyle=a,a={},L.extend(a,this.options.circleStyle,this.options.followCircleStyle),this.options.followCircleStyle=a;var n=L.DomUtil.create("a","control-button "+this.options.icon,e);n.innerHTML="<span class='icon geolocate'></span>",n.href="#",n.title=this.options.strings.title,L.DomEvent.on(n,"click",L.DomEvent.stopPropagation).on(n,"click",L.DomEvent.preventDefault).on(n,"click",function(){o._active&&(void 0===o._event||t.getBounds().contains(o._event.latlng)||!o.options.setView||c())?f():i()}).on(n,"dblclick",L.DomEvent.stopPropagation);var i=function(){o.options.setView&&(o._locateOnNextLocationFound=!0),o._active||t.locate(o._locateOptions),o._active=!0,o.options.follow&&s(),o._event?d():u("requesting")},r=function(t){o._event&&o._event.latlng.lat===t.latlng.lat&&o._event.latlng.lng===t.latlng.lng&&o._event.accuracy===t.accuracy||o._active&&(o._event=t,o.options.follow&&o._following&&(o._locateOnNextLocationFound=!0),d())},s=function(){t.fire("startfollowing",o),o._following=!0,o.options.stopFollowingOnDrag&&t.on("dragstart",l)},l=function(){t.fire("stopfollowing",o),o._following=!1,o.options.stopFollowingOnDrag&&t.off("dragstart",l),d()},c=function(){return void 0===o._event?!1:t.options.maxBounds&&!t.options.maxBounds.contains(o._event.latlng)},d=function(){void 0===o._event.accuracy&&(o._event.accuracy=0);var e=o._event.accuracy;o._locateOnNextLocationFound&&(c()?o.options.onLocationOutsideMapBounds(o):t.fitBounds(o._event.bounds,{padding:o.options.circlePadding,maxZoom:o.options.keepCurrentZoomLevel?t.getZoom():o._locateOptions.maxZoom}),o._locateOnNextLocationFound=!1);var a,n;if(o.options.drawCircle)if(a=o._following?o.options.followCircleStyle:o.options.circleStyle,o._circle){o._circle.setLatLng(o._event.latlng).setRadius(e);for(n in a)o._circle.options[n]=a[n]}else o._circle=L.circle(o._event.latlng,e,a).addTo(o._layer);var i,r;o.options.metric?(i=e.toFixed(0),r="meters"):(i=(3.2808399*e).toFixed(0),r="feet");var s;s=o._following?o.options.followMarkerStyle:o.options.markerStyle;var l=o.options.strings.popup;if(o._circleMarker){o._circleMarker.setLatLng(o._event.latlng).bindPopup(L.Util.template(l,{distance:i,unit:r}))._popup.setLatLng(o._event.latlng);for(n in s)o._circleMarker.options[n]=s[n]}else o._circleMarker=L.circleMarker(o._event.latlng,s).bindPopup(L.Util.template(l,{distance:i,unit:r})).addTo(o._layer);o._container&&u(o._following?"following":"active")},u=function(t){"requesting"==t?(L.DomUtil.removeClasses(o._container,"active following"),L.DomUtil.addClasses(o._container,"requesting"),L.DomUtil.removeClasses(n,o.options.icon),L.DomUtil.addClasses(n,o.options.iconLoading)):"active"==t?(L.DomUtil.removeClasses(o._container,"requesting following"),L.DomUtil.addClasses(o._container,"active"),L.DomUtil.removeClasses(n,o.options.iconLoading),L.DomUtil.addClasses(n,o.options.icon)):"following"==t&&(L.DomUtil.removeClasses(o._container,"requesting"),L.DomUtil.addClasses(o._container,"active following"),L.DomUtil.removeClasses(n,o.options.iconLoading),L.DomUtil.addClasses(n,o.options.icon))},p=function(){o._active=!1,o._locateOnNextLocationFound=o.options.setView,o._following=!1};p();var f=function(){t.stopLocate(),t.off("dragstart",l),o.options.follow&&o._following&&l(),L.DomUtil.removeClass(o._container,"requesting"),L.DomUtil.removeClass(o._container,"active"),L.DomUtil.removeClass(o._container,"following"),p(),o._layer.clearLayers(),o._circleMarker=void 0,o._circle=void 0},m=function(t){3==t.code&&o._locateOptions.watch||(f(),o.options.onLocationError(t))};return t.on("locationfound",r,o),t.on("locationerror",m,o),this.locate=i,this.stopLocate=f,this.stopFollowing=l,e}}),L.Map.addInitHook(function(){this.options.locateControl&&(this.locateControl=L.control.locate(),this.addControl(this.locateControl))}),L.control.locate=function(t){return new L.Control.Locate(t)},function(){var t=function(t,e,o){o=o.split(" "),o.forEach(function(o){L.DomUtil[t].call(this,e,o)})};L.DomUtil.addClasses=function(e,o){t("addClass",e,o)},L.DomUtil.removeClasses=function(e,o){t("removeClass",e,o)}}(),L.OSM.layers=function(t){var e=L.control(t);return e.onAdd=function(e){function o(t,o,a){var n=$("<li>").tooltip({placement:"top"}).appendTo(d),i=$("<label>").appendTo(n),r=e.hasLayer(t),s=$("<input>").attr("type","checkbox").prop("checked",r).appendTo(i);i.append(I18n.t("javascripts.map.layers."+o)),s.on("change",function(){r=s.is(":checked"),r?e.addLayer(t):e.removeLayer(t),e.fire("overlaylayerchange",{layer:t})}),e.on("layeradd layerremove",function(){s.prop("checked",e.hasLayer(t))}),e.on("zoomend",function(){var t=e.getBounds().getSize()>=a;$(s).prop("disabled",t),t&&$(s).is(":checked")?($(s).prop("checked",!1).trigger("change"),r=!0):t||$(s).is(":checked")||!r||$(s).prop("checked",!0).trigger("change"),$(n).attr("class",t?"disabled":""),n.attr("data-original-title",t?I18n.t("javascripts.site.map_"+o+"_zoom_in_tooltip"):"")})}function a(e){e.stopPropagation(),e.preventDefault(),t.sidebar.togglePane(s,r),$(".leaflet-control .control-button").tooltip("hide")}var n=t.layers,i=$("<div>").attr("class","control-layers"),r=$("<a>").attr("class","control-button").attr("href","#").attr("title",I18n.t("javascripts.map.layers.title")).html('<span class="icon layers"></span>').on("click",a).appendTo(i),s=$("<div>").attr("class","layers-ui");$("<div>").attr("class","sidebar_heading").appendTo(s).append($("<span>").text(I18n.t("javascripts.close")).attr("class","icon close").bind("click",a)).append($("<h4>").text(I18n.t("javascripts.map.layers.header")));var l=$("<div>").attr("class","section base-layers").appendTo(s);if(d=$("<ul>").appendTo(l),n.forEach(function(t){var o=$("<li>").appendTo(d);e.hasLayer(t)&&o.addClass("active");var a=$("<div>").appendTo(o);e.whenReady(function(){function o(){l.invalidateSize(),r({animate:!1}),e.on("moveend",i)}function n(){e.off("moveend",i)}function i(){r()}function r(t){l.setView(e.getCenter(),Math.max(e.getZoom()-2,0),t)}var l=L.map(a[0],{attributionControl:!1,zoomControl:!1}).addLayer(new t.constructor);l.dragging.disable(),l.touchZoom.disable(),l.doubleClickZoom.disable(),l.scrollWheelZoom.disable(),s.on("show",o).on("hide",n)});var i=$("<label>").appendTo(o),r=$("<input>").attr("type","radio").prop("checked",e.hasLayer(t)).appendTo(i);i.append(t.options.name),o.on("click",function(){n.forEach(function(o){o===t?e.addLayer(o):e.removeLayer(o)}),e.fire("baselayerchange",{layer:t})}),e.on("layeradd layerremove",function(){o.toggleClass("active",e.hasLayer(t)),r.prop("checked",e.hasLayer(t))})}),"api_offline"!=OSM.STATUS&&"database_offline"!=OSM.STATUS){var c=$("<div>").attr("class","section overlay-layers").appendTo(s);$("<p>").text(I18n.t("javascripts.map.layers.overlays")).attr("class","deemphasize").appendTo(c);var d=$("<ul>").appendTo(c);o(e.noteLayer,"notes",OSM.MAX_NOTE_REQUEST_AREA),o(e.dataLayer,"data",OSM.MAX_REQUEST_AREA)}return t.sidebar.addPane(s),i[0]},e},L.OSM.key=function(t){var e=L.control(t);return e.onAdd=function(e){function o(){e.on("zoomend baselayerchange",r),d.load("/key",r)}function a(){e.off("zoomend baselayerchange",r)}function n(e){e.stopPropagation(),e.preventDefault(),l.hasClass("disabled")||t.sidebar.togglePane(c,l),$(".leaflet-control .control-button").tooltip("hide")}function i(){var t="mapnik"!==e.getMapBaseLayerId();l.toggleClass("disabled",t).attr("data-original-title",I18n.t(t?"javascripts.key.tooltip_disabled":"javascripts.key.tooltip"))}function r(){var t=e.getMapBaseLayerId(),o=e.getZoom();$(".mapkey-table-entry").each(function(){var e=$(this).data();t==e.layer&&o>=e.zoomMin&&o<=e.zoomMax?$(this).show():$(this).hide()})}var s=$("<div>").attr("class","control-key"),l=$("<a>").attr("class","control-button").attr("href","#").html('<span class="icon key"></span>').on("click",n).appendTo(s),c=$("<div>").attr("class","key-ui");$("<div>").attr("class","sidebar_heading").appendTo(c).append($("<span>").text(I18n.t("javascripts.close")).attr("class","icon close").bind("click",n)).append($("<h4>").text(I18n.t("javascripts.key.title")));var d=$("<div>").attr("class","section").appendTo(c);return t.sidebar.addPane(c),c.on("show",o).on("hide",a),e.on("baselayerchange",i),i(),s[0]},e},L.OSM.note=function(t){var e=L.control(t);return e.onAdd=function(t){function e(){var e=t.getZoom()<12;a.toggleClass("disabled",e).attr("data-original-title",I18n.t(e?"javascripts.site.createnote_disabled_tooltip":"javascripts.site.createnote_tooltip"))}var o=$("<div>").attr("class","control-note"),a=$("<a>").attr("class","control-button").attr("href","#").html('<span class="icon note"></span>').appendTo(o);return t.on("zoomend",e),e(),o[0]},e},L.OSM.share=function(t){var e=L.control(t),o=L.marker([0,0],{draggable:!0}),a=new L.LocationFilter({enableButton:!1,adjustButton:!1});return e.onAdd=function(e){function n(){e.removeLayer(o),e.options.scrollWheelZoom=e.options.doubleClickZoom=!0,a.disable(),u()}function i(a){a.stopPropagation(),a.preventDefault(),$("#mapnik_scale").val(f()),o.setLatLng(e.getCenter()),u(),t.sidebar.togglePane(g,v),$(".leaflet-control .control-button").tooltip("hide")}function r(){$(this).is(":checked")?(o.setLatLng(e.getCenter()),e.addLayer(o),e.options.scrollWheelZoom=e.options.doubleClickZoom="center"):(e.removeLayer(o),e.options.scrollWheelZoom=e.options.doubleClickZoom=!0),u()}function s(){$(this).is(":checked")?(a.setBounds(e.getBounds().pad(-.2)),a.enable()):a.disable(),u()}function l(){o.setLatLng(e.getCenter()),u()}function c(){e.hasLayer(o)&&(e.off("move",l),e.on("moveend",d),e.panTo(o.getLatLng()))}function d(){e.off("moveend",d),e.on("move",l),u()}function u(){var t=e.getBounds();$("#link_marker").prop("checked",e.hasLayer(o)),$("#image_filter").prop("checked",a.isEnabled()),$("#short_input").val(e.getShortUrl(o)),$("#long_input").val(e.getUrl(o)),$("#short_link").attr("href",e.getShortUrl(o)),$("#long_link").attr("href",e.getUrl(o));var n={bbox:t.toBBoxString(),layer:e.getMapBaseLayerId()};if(e.hasLayer(o)){var i=o.getLatLng().wrap();n.marker=i.lat+","+i.lng}$("#embed_html").val('<iframe width="425" height="350" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="'+escapeHTML("http://"+OSM.SERVER_URL+"/export/embed.html?"+$.param(n))+'" style="border: 1px solid black"></iframe><br/><small><a href="'+escapeHTML(e.getUrl(o))+'">'+escapeHTML(I18n.t("javascripts.share.view_larger_map"))+"</a></small>"),a.isEnabled()&&(t=a.getBounds());var r=$("#mapnik_scale").val(),s=L.bounds(L.CRS.EPSG3857.project(t.getSouthWest()),L.CRS.EPSG3857.project(t.getNorthEast())).getSize(),l=Math.floor(Math.sqrt(s.x*s.y/.3136));$("#mapnik_minlon").val(t.getWest()),$("#mapnik_minlat").val(t.getSouth()),$("#mapnik_maxlon").val(t.getEast()),$("#mapnik_maxlat").val(t.getNorth()),l>r&&(r=m(l),$("#mapnik_scale").val(r)),$("#mapnik_image_width").text(Math.round(s.x/r/28e-5)),$("#mapnik_image_height").text(Math.round(s.y/r/28e-5))}function p(){$(this).select()}function f(){var t=e.getBounds(),o=t.getCenter().lat,a=6378137*Math.PI*Math.cos(o*Math.PI/180),n=a*(t.getEast()-t.getWest())/180,i=e.getSize().x/n,r=1/3622.0492;return Math.round(1/(i*r))}function m(t){var e=5*Math.pow(10,Math.floor(Math.LOG10E*Math.log(t))-2);return e*Math.ceil(t/e)}var h=$("<div>").attr("class","control-share"),v=$("<a>").attr("class","control-button").attr("href","#").attr("title",I18n.t("javascripts.share.title")).html('<span class="icon share"></span>').on("click",i).appendTo(h),g=$("<div>").attr("class","share-ui");$("<div>").attr("class","sidebar_heading").appendTo(g).append($("<span>").text(I18n.t("javascripts.close")).attr("class","icon close").bind("click",i)).append($("<h4>").text(I18n.t("javascripts.share.title")));var y=$("<div>").attr("class","section share-link").appendTo(g);$("<h4>").text(I18n.t("javascripts.share.link")).appendTo(y);var b=$("<form>").attr("class","standard-form").appendTo(y);$("<div>").attr("class","form-row").appendTo(b).append($("<label>").attr("for","link_marker").append($("<input>").attr("id","link_marker").attr("type","checkbox").bind("change",r)).append(I18n.t("javascripts.share.include_marker"))),$("<div>").attr("class","share-tabs").appendTo(b).append($("<a>").attr("class","active").attr("for","long_input").attr("id","long_link").text(I18n.t("javascripts.share.long_link"))).append($("<a>").attr("for","short_input").attr("id","short_link").text(I18n.t("javascripts.share.short_link"))).append($("<a>").attr("for","embed_html").attr("href","#").text(I18n.t("javascripts.share.embed"))).on("click","a",function(t){t.preventDefault();var e="#"+$(this).attr("for");y.find(".share-tabs a").removeClass("active"),$(this).addClass("active"),y.find(".share-tab").hide(),y.find(".share-tab:has("+e+")").show().find("input, textarea").select()}),$("<div>").attr("class","form-row share-tab").css("display","block").appendTo(b).append($("<input>").attr("id","long_input").attr("type","text").on("click",p)),$("<div>").attr("class","form-row share-tab").appendTo(b).append($("<input>").attr("id","short_input").attr("type","text").on("click",p)),$("<div>").attr("class","form-row share-tab").appendTo(b).append($("<textarea>").attr("id","embed_html").on("click",p)).append($("<p>").attr("class","deemphasize").text(I18n.t("javascripts.share.paste_html")).appendTo(y));var _=$("<div>").attr("class","section share-image").appendTo(g);return $("<h4>").text(I18n.t("javascripts.share.image")).appendTo(_),b=$("<form>").attr("class","standard-form").attr("action","/export/finish").attr("method","post").appendTo(_),$("<div>").attr("class","form-row").appendTo(b).append($("<label>").attr("for","image_filter").append($("<input>").attr("id","image_filter").attr("type","checkbox").bind("change",s)).append(I18n.t("javascripts.share.custom_dimensions"))),$("<div>").attr("class","form-row").appendTo(b).append($("<label>").attr("for","mapnik_format").text(I18n.t("javascripts.share.format"))).append($("<select>").attr("name","mapnik_format").attr("id","mapnik_format").append($("<option>").val("png").text("PNG").prop("selected",!0)).append($("<option>").val("jpeg").text("JPEG")).append($("<option>").val("svg").text("SVG")).append($("<option>").val("pdf").text("PDF"))),$("<div>").attr("class","form-row").appendTo(b).append($("<label>").attr("for","mapnik_scale").text(I18n.t("javascripts.share.scale"))).append("1 : ").append($("<input>").attr("name","mapnik_scale").attr("id","mapnik_scale").attr("type","text").on("change",u)),["minlon","minlat","maxlon","maxlat"].forEach(function(t){$("<input>").attr("id","mapnik_"+t).attr("name",t).attr("type","hidden").appendTo(b)}),$("<input>").attr("name","format").attr("value","mapnik").attr("type","hidden").appendTo(b),$("<p>").attr("class","deemphasize").html(I18n.t("javascripts.share.image_size")+' <span id="mapnik_image_width"></span> x <span id="mapnik_image_height"></span>').appendTo(b),$("<input>").attr("type","submit").attr("value",I18n.t("javascripts.share.download")).appendTo(b),a.on("change",u).addTo(e),o.on("dragend",c),e.on("move",l),e.on("moveend layeradd layerremove",u),t.sidebar.addPane(g),g.on("hide",n),h[0]},e},L.OSM.query=function(t){var e=L.control(t);return e.onAdd=function(t){function e(){var e=a.hasClass("disabled"),o=t.getZoom()<14;a.toggleClass("disabled",o).attr("data-original-title",I18n.t(o?"javascripts.site.queryfeature_disabled_tooltip":"javascripts.site.queryfeature_tooltip")),o&&!e?a.trigger("disabled"):e&&!o&&a.trigger("enabled")}var o=$("<div>").attr("class","control-query"),a=$("<a>").attr("class","control-button").attr("href","#").html('<span class="icon query"></span>').appendTo(o);return t.on("zoomend",e),e(),o[0]},e},function(t,e){function o(e){var o,a=t(e.ownerDocument);return e=t(e),o=e.offset(),{x:o.left+e.outerWidth()/2-a.scrollLeft(),y:o.top+e.outerHeight()/2-a.scrollTop()}}function a(e){var o,a=t(e.ownerDocument);return e=t(e),o=e.offset(),{x:o.left-a.scrollLeft(),y:o.top-a.scrollTop()}}var n=/^key/,i=/^(?:mouse|contextmenu)|click/;t.fn.simulate=function(e,o){return this.each(function(){new t.simulate(this,e,o)})},t.simulate=function(e,o,a){var n=t.camelCase("simulate-"+o);this.target=e,this.options=a,this[n]?this[n]():this.simulateEvent(e,o,a)},t.extend(t.simulate,{keyCode:{BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,NUMPAD_ADD:107,NUMPAD_DECIMAL:110,NUMPAD_DIVIDE:111,NUMPAD_ENTER:108,NUMPAD_MULTIPLY:106,NUMPAD_SUBTRACT:109,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38},buttonCode:{LEFT:0,MIDDLE:1,RIGHT:2}}),t.extend(t.simulate.prototype,{simulateEvent:function(t,e,o){var a=this.createEvent(e,o);this.dispatchEvent(t,e,a,o)},createEvent:function(t,e){return n.test(t)?this.keyEvent(t,e):i.test(t)?this.mouseEvent(t,e):void 0},mouseEvent:function(o,a){var n,i,r,s;return a=t.extend({bubbles:!0,cancelable:"mousemove"!==o,view:window,detail:0,screenX:0,screenY:0,clientX:1,clientY:1,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,button:0,relatedTarget:e},a),document.createEvent?(n=document.createEvent("MouseEvents"),n.initMouseEvent(o,a.bubbles,a.cancelable,a.view,a.detail,a.screenX,a.screenY,a.clientX,a.clientY,a.ctrlKey,a.altKey,a.shiftKey,a.metaKey,a.button,a.relatedTarget||document.body.parentNode),0===n.pageX&&0===n.pageY&&Object.defineProperty&&(i=n.relatedTarget.ownerDocument||document,r=i.documentElement,s=i.body,Object.defineProperty(n,"pageX",{get:function(){return a.clientX+(r&&r.scrollLeft||s&&s.scrollLeft||0)-(r&&r.clientLeft||s&&s.clientLeft||0)}}),Object.defineProperty(n,"pageY",{get:function(){return a.clientY+(r&&r.scrollTop||s&&s.scrollTop||0)-(r&&r.clientTop||s&&s.clientTop||0)}}))):document.createEventObject&&(n=document.createEventObject(),t.extend(n,a),n.button={0:1,1:4,2:2}[n.button]||n.button),n},keyEvent:function(o,a){var n;if(a=t.extend({bubbles:!0,cancelable:!0,view:window,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,keyCode:0,charCode:e},a),document.createEvent)try{n=document.createEvent("KeyEvents"),n.initKeyEvent(o,a.bubbles,a.cancelable,a.view,a.ctrlKey,a.altKey,a.shiftKey,a.metaKey,a.keyCode,a.charCode)}catch(i){n=document.createEvent("Events"),n.initEvent(o,a.bubbles,a.cancelable),t.extend(n,{view:a.view,ctrlKey:a.ctrlKey,altKey:a.altKey,shiftKey:a.shiftKey,metaKey:a.metaKey,keyCode:a.keyCode,charCode:a.charCode})}else document.createEventObject&&(n=document.createEventObject(),t.extend(n,a));return(/msie [\w.]+/.exec(navigator.userAgent.toLowerCase())||"[object Opera]"==={}.toString.call(window.opera))&&(n.keyCode=a.charCode>0?a.charCode:a.keyCode,n.charCode=e),n},dispatchEvent:function(t,e,o){t.dispatchEvent?t.dispatchEvent(o):t.fireEvent&&t.fireEvent("on"+e,o)},simulateFocus:function(){function e(){a=!0}var o,a=!1,n=t(this.target);n.bind("focus",e),n[0].focus(),a||(o=t.Event("focusin"),o.preventDefault(),n.trigger(o),n.triggerHandler("focus")),n.unbind("focus",e)},simulateBlur:function(){function e(){a=!0}var o,a=!1,n=t(this.target);n.bind("blur",e),n[0].blur(),setTimeout(function(){n[0].ownerDocument.activeElement===n[0]&&n[0].ownerDocument.body.focus(),a||(o=t.Event("focusout"),o.preventDefault(),n.trigger(o),n.triggerHandler("blur")),n.unbind("blur",e)},1)}}),t.extend(t.simulate.prototype,{simulateDrag:function(){var n=0,i=this.target,r=this.options,s="corner"===r.handle?a(i):o(i),l=Math.floor(s.x),c=Math.floor(s.y),d={clientX:l,clientY:c},u=r.dx||(r.x!==e?r.x-l:0),p=r.dy||(r.y!==e?r.y-c:0),f=r.moves||3;for(this.simulateEvent(i,"mousedown",d);f>n;n++)l+=u/f,c+=p/f,d={clientX:Math.round(l),clientY:Math.round(c)},this.simulateEvent(i.ownerDocument,"mousemove",d);t.contains(document,i)?(this.simulateEvent(i,"mouseup",d),this.simulateEvent(i,"click",d)):this.simulateEvent(document,"mouseup",d)}})}(jQuery),OSM.Search=function(t){function e(t){t.preventDefault(),t.stopPropagation();var e=$(this).parents(".search_more");$(this).hide(),e.find(".loader").show(),$.get($(this).attr("href"),function(t){e.replaceWith(t)})}function o(){var t=$(this).data("marker");if(!t){var e=$(this).find("a.set_position").data();t=L.marker([e.lat,e.lon],{icon:getUserIcon()}),$(this).data("marker",t)}i.addLayer(t),$(this).closest("li").addClass("selected")}function a(){var t=$(this).data("marker");t&&i.removeLayer(t),$(this).closest("li").removeClass("selected")}function n(e){var o=$(this).data(),a=L.latLng(o.lat,o.lon);o.minLon&&o.minLat&&o.maxLon&&o.maxLat?t.fitBounds([[o.minLat,o.minLon],[o.maxLat,o.maxLon]]):t.setView(a,o.zoom),o.type&&o.id||(e.preventDefault(),e.stopPropagation())}$(".search_form input[name=query]").on("input",function(t){""==$(t.target).val()?$(".describe_location").fadeIn(100):$(".describe_location").fadeOut(100)}),$("#sidebar_content").on("click",".search_more a",e).on("click",".search_results_entry a.set_position",n).on("mouseover","p.search_results_entry:has(a.set_position)",o).on("mouseout","p.search_results_entry:has(a.set_position)",a).on("mousedown","p.search_results_entry:has(a.set_position)",function(){var t=!1;$(this).one("click",function(e){t||$(e.target).is("a")||$(this).find("a.set_position").simulate("click",e)}).one("mousemove",function(){t=!0})});var i=L.layerGroup().addTo(t),r={};return r.pushstate=r.popstate=function(t){var e=querystring.parse(t.substring(t.indexOf("?")+1));$(".search_form input[name=query]").val(e.query),OSM.loadSidebarContent(t,r.load)},r.load=function(){return $(".search_results_entry").each(function(){var e=$(this);$.ajax({url:e.data("href"),method:"GET",data:{zoom:t.getZoom(),minlon:t.getBounds().getWest(),minlat:t.getBounds().getSouth(),maxlon:t.getBounds().getEast(),maxlat:t.getBounds().getNorth()},success:function(t){e.html(t)}})}),t.getState()},r.unload=function(){i.clearLayers(),$(".search_form input[name=query]").val(""),$(".describe_location").fadeIn(100)},r},OSM.Export=function(t){function e(){return L.latLngBounds(L.latLng($("#minlat").val(),$("#minlon").val()),L.latLng($("#maxlat").val(),$("#maxlon").val()))}function o(){var o=e();t.fitBounds(o),c.setBounds(o),c.enable(),r()}function a(e){e.preventDefault(),$("#drag_box").hide(),c.setBounds(t.getBounds().pad(-.2)),c.enable(),r()}function n(){i(c.isEnabled()?c.getBounds():t.getBounds()),r()}function i(e){var o=OSM.zoomPrecision(t.getZoom());$("#minlon").val(e.getWest().toFixed(o)),$("#minlat").val(e.getSouth().toFixed(o)),$("#maxlon").val(e.getEast().toFixed(o)),$("#maxlat").val(e.getNorth().toFixed(o)),$("#export_overpass").attr("href","http://overpass-api.de/api/map?bbox="+$("#minlon").val()+","+$("#minlat").val()+","+$("#maxlon").val()+","+$("#maxlat").val())}function r(){$("#export_osm_too_large").toggle(e().getSize()>OSM.MAX_REQUEST_AREA),$("#export_commit").toggle(e().getSize()<OSM.MAX_REQUEST_AREA)}function s(t){e().getSize()>OSM.MAX_REQUEST_AREA&&t.preventDefault()}var l={},c=new L.LocationFilter({enableButton:!1,adjustButton:!1}).on("change",n);return l.pushstate=l.popstate=function(t){$("#export_tab").addClass("current"),OSM.loadSidebarContent(t,l.load)},l.load=function(){return t.addLayer(c).on("moveend",n),$("#maxlat, #minlon, #maxlon, #minlat").change(o),$("#drag_box").click(a),$(".export_form").on("submit",s),n(),t.getState()},l.unload=function(){t.removeLayer(c).off("moveend",n),$("#export_tab").removeClass("current")
},l},OSM.History=function(t){function e(t){l.getLayer(t).setStyle({fillOpacity:.3}),$("#changeset_"+t).addClass("selected")}function o(t){l.getLayer(t).setStyle({fillOpacity:0}),$("#changeset_"+t).removeClass("selected")}function a(t,e){$("#changeset_"+t).find("a.changeset_id").simulate("click",e)}function n(){var e={list:"1"};"/history"===window.location.pathname&&(e.bbox=t.getBounds().wrap().toBBoxString()),$.ajax({url:window.location.pathname,method:"GET",data:e,success:function(t){$("#sidebar_content .changesets").html(t),r()}});var o=$('link[type="application/atom+xml"]'),a=o.attr("href").split("?")[0];o.attr("href",a+"?bbox="+e.bbox)}function i(t){t.preventDefault(),t.stopPropagation();var e=$(this).parents(".changeset_more");$(this).hide(),e.find(".loader").show(),$.get($(this).attr("href"),function(t){e.replaceWith(t),r()})}function r(){l.clearLayers();var e=[];$("[data-changeset]").each(function(){var t=$(this).data("changeset");t.bbox&&(t.bounds=L.latLngBounds([t.bbox.minlat,t.bbox.minlon],[t.bbox.maxlat,t.bbox.maxlon]),e.push(t))}),e.sort(function(t,e){return e.bounds.getSize()-t.bounds.getSize()});for(var o=0;o<e.length;++o){var a=e[o],n=L.rectangle(a.bounds,{weight:2,color:"#FF9500",opacity:1,fillColor:"#FFFFBF",fillOpacity:0});n.id=a.id,n.addTo(l)}if("/history"!==window.location.pathname){var i=l.getBounds();i.isValid()&&t.fitBounds(i)}}var s={};$("#sidebar_content").on("click",".changeset_more a",i).on("mouseover","[data-changeset]",function(){e($(this).data("changeset").id)}).on("mouseout","[data-changeset]",function(){o($(this).data("changeset").id)}).on("mousedown","[data-changeset]",function(){var t=!1;$(this).one("click",function(e){t||$(e.target).is("a")||a($(this).data("changeset").id,e)}).one("mousemove",function(){t=!0})});var l=L.featureGroup().on("mouseover",function(t){e(t.layer.id)}).on("mouseout",function(t){o(t.layer.id)}).on("click",function(t){a(t.layer.id,t)});return l.getLayerId=function(t){return t.id},s.pushstate=s.popstate=function(t){$("#history_tab").addClass("current"),OSM.loadSidebarContent(t,s.load)},s.load=function(){t.addLayer(l),"/history"===window.location.pathname&&t.on("moveend",n),n()},s.unload=function(){t.removeLayer(l),t.off("moveend",n),$("#history_tab").removeClass("current")},s},OSM.Note=function(t){function e(t,e,o){$(t).find("input[type=submit]").prop("disabled",!0),$.ajax({url:o,type:e,oauth:!0,data:{text:$(t.text).val()},success:function(){OSM.loadSidebarContent(window.location.pathname,s.load)}})}function o(o){r.find("input[type=submit]").on("click",function(t){t.preventDefault();var o=$(t.target).data();e(t.target.form,o.method,o.url)}),r.find("textarea").on("input",function(t){var e=t.target.form;""==$(t.target).val()?($(e.close).val(I18n.t("javascripts.notes.show.resolve")),$(e.comment).prop("disabled",!0)):($(e.close).val(I18n.t("javascripts.notes.show.comment_and_resolve")),$(e.comment).prop("disabled",!1))}),r.find("textarea").val("").trigger("input");var a=$(".details").data(),s=L.latLng(a.coordinates.split(","));t.hasLayer(n)||(n=L.circleMarker(s,{weight:2.5,radius:20,fillOpacity:.5,color:"#FF6200"}),t.addLayer(n)),t.hasLayer(i)&&t.removeLayer(i),i=L.marker(s,{icon:l[a.status],opacity:1,clickable:!0}),t.addLayer(i),o&&o()}function a(){var e=$(".details").data(),o=L.latLng(e.coordinates.split(","));(!window.location.hash||window.location.hash.match(/^#?c[0-9]+$/))&&OSM.router.withoutMoveListener(function(){t.setView(o,15,{reset:!0})})}var n,i,r=(t.noteLayer,$("#sidebar_content")),s={},l={"new":L.icon({iconUrl:"/assets/new_note_marker-f288a218f297b58fa66b991944736848.png",iconSize:[25,40],iconAnchor:[12,40]}),open:L.icon({iconUrl:"/assets/open_note_marker-d4c52755bf53d8cac761620aebaee4b4.png",iconSize:[25,40],iconAnchor:[12,40]}),closed:L.icon({iconUrl:"/assets/closed_note_marker-90bceb5b3498278726d1608c306c2d0f.png",iconSize:[25,40],iconAnchor:[12,40]})};return s.pushstate=s.popstate=function(e){OSM.loadSidebarContent(e,function(){o(function(){var e=$(".details").data(),o=L.latLng(e.coordinates.split(","));t.getBounds().contains(o)||a()})})},s.load=function(){o(a)},s.unload=function(){t.hasLayer(n)&&t.removeLayer(n),t.hasLayer(i)&&t.removeLayer(i)},s},OSM.NewNote=function(t){function e(t,e,a){function i(t,e){s.find("textarea").val(""),o(t),n=null,r.removeLayer(e),c.removeClass("active"),OSM.router.route("/note/"+t.properties.id)}var l=t.getLatLng().wrap();t.options.draggable=!1,t.dragging.disable(),$(e).find("input[type=submit]").prop("disabled",!0),$.ajax({url:a,type:"POST",oauth:!0,data:{lat:l.lat,lon:l.lng,text:$(e.text).val()},success:function(e){i(e,t)}})}function o(t){var e=L.marker(t.geometry.coordinates.reverse(),{icon:d[t.properties.status],opacity:.9,clickable:!0});return e.id=t.properties.id,e.addTo(r),e}function a(e,o){"dragstart"==o&&t.hasLayer(i)?t.removeLayer(i):(t.hasLayer(i)&&t.removeLayer(i),i=L.circleMarker(e,{weight:2.5,radius:20,fillOpacity:.5,color:"#FF6200"}),t.addLayer(i))}var n,i,r=t.noteLayer,s=$("#sidebar_content"),l={},c=$(".control-note .control-button"),d={"new":L.icon({iconUrl:"/assets/new_note_marker-f288a218f297b58fa66b991944736848.png",iconSize:[25,40],iconAnchor:[12,40]}),open:L.icon({iconUrl:"/assets/open_note_marker-d4c52755bf53d8cac761620aebaee4b4.png",iconSize:[25,40],iconAnchor:[12,40]}),closed:L.icon({iconUrl:"/assets/closed_note_marker-90bceb5b3498278726d1608c306c2d0f.png",iconSize:[25,40],iconAnchor:[12,40]})};return c.on("click",function(t){t.preventDefault(),t.stopPropagation(),$(this).hasClass("disabled")||OSM.router.route("/note/new")}),l.pushstate=l.popstate=function(t){OSM.loadSidebarContent(t,l.load)},l.load=function(){function o(t){$(t.target.form.add).prop("disabled",""===$(t.target).val())}if(!c.hasClass("disabled")&&!c.hasClass("active")){c.addClass("active"),t.addLayer(r);var i,l=t.getSize();return i=l.y>800?[l.x/2,l.y/2]:l.y>400?[l.x/2,400]:[l.x/2,l.y],n=L.marker(t.containerPointToLatLng(i),{icon:d["new"],opacity:.9,draggable:!0}),n.on("dragstart dragend",function(t){a(n.getLatLng(),t.type)}),n.addTo(r),a(n.getLatLng()),n.on("remove",function(){c.removeClass("active")}).on("dragstart",function(){$(n).stopTime("removenote")}).on("dragend",function(){s.find("textarea").focus()}),s.find("textarea").on("input",o).focus(),s.find("input[type=submit]").on("click",function(t){t.preventDefault(),e(n,t.target.form,"/api/0.6/notes.json")}),t.getState()}},l.unload=function(){r.removeLayer(n),t.removeLayer(i),c.removeClass("active")},l},OSM.Changeset=function(t){function e(e,o){t.addObject({type:"changeset",id:parseInt(e)},function(e){window.location.hash||!e.isValid()||!o&&t.getBounds().contains(e)||OSM.router.withoutMoveListener(function(){t.fitBounds(e)})})}function o(t,e,o,a){$(t).find("input[type=submit]").prop("disabled",!0),data=a?{text:$(t.text).val()}:{},$.ajax({url:o,type:e,oauth:!0,data:data,success:function(){OSM.loadSidebarContent(window.location.pathname,i.load)}})}function a(){r.find("input[name=comment]").on("click",function(t){t.preventDefault();var e=$(t.target).data();o(t.target.form,e.method,e.url,!0)}),r.find(".action-button").on("click",function(t){t.preventDefault();var e=$(t.target).data();o(t.target.form,e.method,e.url)}),r.find("textarea").on("input",function(t){var e=t.target.form;""==$(t.target).val()?$(e.comment).prop("disabled",!0):$(e.comment).prop("disabled",!1)}),r.find("textarea").val("").trigger("input")}var n,i={},r=$("#sidebar_content");return i.pushstate=i.popstate=function(t,e){OSM.loadSidebarContent(t,function(){i.load(t,e)})},i.load=function(t,o){o&&(n=o),a(),e(n,!0)},i.unload=function(){t.removeObject()},i},OSM.Query=function(t){function e(t){if(t.tags)for(var e in t.tags)if(h.indexOf(e)<0)return!0;return!1}function o(t){var e=t.tags,o="";if("administrative"===e.boundary)o=I18n.t("geocoder.search_osm_nominatim.admin_levels.level"+e.admin_level);else{var a=I18n.t("geocoder.search_osm_nominatim.prefix");for(var n in e){var i=e[n];if(a[n]){if(a[n][i])return a[n][i];var r=i.substr(0,1).toUpperCase(),s=i.substr(1).replace(/_/g," ");return r+s}}}return o||(o=I18n.t("javascripts.query."+t.type)),o}function a(t){var e=t.tags;return e.name?e.name:e.ref?e.ref:e["addr:housename"]?e["addr:housename"]:e["addr:housenumber"]&&e["addr:street"]?e["addr:housenumber"]+" "+e["addr:street"]:"#"+t.id}function n(t){var e;return"node"===t.type&&t.lat&&t.lon?e=L.circleMarker([t.lat,t.lon],v):"way"===t.type&&t.geometry?e=L.polyline(t.geometry.filter(function(t){return null!==t}).map(function(t){return[t.lat,t.lon]}),v):"relation"===t.type&&t.members&&(e=L.featureGroup(t.members.map(n).filter(function(t){return void 0!==t}))),e}function i(t,i,r,s,l){var c=s.find("ul");c.empty(),s.show(),s.find(".loader").oneTime(1e3,"loading",function(){$(this).show()}),s.data("ajax")&&s.data("ajax").abort(),s.data("ajax",$.ajax({url:f,method:"POST",data:{data:"[timeout:5][out:json];"+r},success:function(r){var d;s.find(".loader").stopTime("loading").hide(),d=l?r.elements.sort(l):r.elements;for(var u=0;u<d.length;u++){var p=d[u];if(e(p,t,i)){var f=$("<li>").addClass("query-result").data("geometry",n(p)).appendTo(c),m=$("<p>").text(o(p)+" ").appendTo(f);$("<a>").attr("href","/"+p.type+"/"+p.id).text(a(p)).appendTo(m)}}0==c.find("li").length&&$("<li>").text(I18n.t("javascripts.query.nothing_found")).appendTo(c)},error:function(t,e,o){s.find(".loader").stopTime("loading").hide(),$("<li>").text(I18n.t("javascripts.query."+e,{server:f,error:o})).appendTo(c)}}))}function r(t,e){var o=t.bounds.maxlon-t.bounds.minlon,a=t.bounds.maxlat-t.bounds.minlat,n=o*a,i=e.bounds.maxlat-e.bounds.minlat,r=e.bounds.maxlat-e.bounds.minlat,s=i*r;return n-s}function s(e,o){var a=L.latLng(e,o),n=t.getBounds(),s=n.getSouth()+","+n.getWest()+","+n.getNorth()+","+n.getEast(),l=10*Math.pow(1.5,19-t.getZoom()),c="around:"+l+","+e+","+o,d="node("+c+")",p="way("+c+")",f="relation("+c+")",m="("+d+";"+p+");out tags geom("+s+");"+f+";out geom("+s+");",h="is_in("+e+","+o+")->.a;way(pivot.a);out tags geom("+s+");relation(pivot.a);out tags bb;";$("#sidebar_content .query-intro").hide(),u&&t.removeLayer(u),u=L.circle(a,l,v).addTo(t),$(document).everyTime(75,"fadeQueryMarker",function(e){10==e?t.removeLayer(u):u.setStyle({opacity:1-.1*e,fillOpacity:.5-.05*e})},10),i(a,l,m,$("#query-nearby")),i(a,l,h,$("#query-isin"),r)}function l(e){var o=OSM.zoomPrecision(t.getZoom()),a=e.latlng.lat.toFixed(o),n=e.latlng.lng.toFixed(o);OSM.router.route("/query?lat="+a+"&lon="+n)}function c(){m.addClass("active"),t.on("click",l),$(t.getContainer()).addClass("query-active")}function d(){u&&t.removeLayer(u),$(t.getContainer()).removeClass("query-active").removeClass("query-disabled"),t.off("click",l),m.removeClass("active")}var u,p="https:"===document.location.protocol?"https:":"http:",f=p+OSM.OVERPASS_URL,m=$(".control-query .control-button"),h=["source","source_ref","source:ref","history","attribution","created_by","tiger:county","tiger:tlid","tiger:upload_uuid","KSJ2:curve_id","KSJ2:lat","KSJ2:lon","KSJ2:coordinate","KSJ2:filename","note:ja"],v={color:"#FF6200",weight:4,opacity:1,fillOpacity:.5,clickable:!1};m.on("click",function(t){t.preventDefault(),t.stopPropagation(),m.hasClass("disabled")||(m.hasClass("active")?d():c())}).on("disabled",function(){m.hasClass("active")&&(t.off("click",l),$(t.getContainer()).removeClass("query-active").addClass("query-disabled"),$(this).tooltip("show"))}).on("enabled",function(){m.hasClass("active")&&(t.on("click",l),$(t.getContainer()).removeClass("query-disabled").addClass("query-active"),$(this).tooltip("hide"))}),$("#sidebar_content").on("mouseover",".query-results li.query-result",function(){var e=$(this).data("geometry");e&&t.addLayer(e),$(this).addClass("selected")}).on("mouseout",".query-results li.query-result",function(){var e=$(this).data("geometry");e&&t.removeLayer(e),$(this).removeClass("selected")}).on("mousedown",".query-results li.query-result",function(){var e=!1;$(this).one("click",function(o){if(!e){var a=$(this).data("geometry");a&&t.removeLayer(a),$(o.target).is("a")||$(this).find("a").simulate("click",o)}}).one("mousemove",function(){e=!0})});var g={};return g.pushstate=g.popstate=function(t){OSM.loadSidebarContent(t,function(){g.load(t,!0)})},g.load=function(e,o){var a=querystring.parse(e.substring(e.indexOf("?")+1)),n=L.latLng(a.lat,a.lon);window.location.hash||o||t.getBounds().contains(n)||OSM.router.withoutMoveListener(function(){t.setView(n,15)}),s(a.lat,a.lon)},g.unload=function(t){t||d()},g},OSM.Router=function(t,e){function o(t,e){var o=new RegExp("^"+t.replace(a,"\\$&").replace(n,"(?:$1)?").replace(i,function(t,e){return e?t:"([^/]+)"}).replace(r,"(.*?)")+"(?:\\?.*)?$"),s={};return s.match=function(t){return o.test(t)},s.run=function(t,a){var n=[];return a&&(n=o.exec(a).map(function(t,e){return e>0&&t?decodeURIComponent(t):t})),n=n.concat(Array.prototype.slice.call(arguments,2)),(e[t]||$.noop).apply(e,n)},s}var a=/[\-{}\[\]+?.,\\\^$|#\s]/g,n=/\((.*?)\)/g,i=/(\(\?)?:\w+/g,r=/\*\w+/g,s=[];for(var l in e)s.push(o(l,e[l]));s.recognize=function(t){for(var e=0;e<this.length;e++)if(this[e].match(t))return this[e]};var c=window.location.pathname.replace(/(.)\/$/,"$1")+window.location.search,d=s.recognize(c),u=location.hash||OSM.formatHash(t),p={};return window.history&&window.history.pushState?($(window).on("popstate",function(e){if(e.originalEvent.state){var o=window.location.pathname+window.location.search,a=s.recognize(o);o!==c&&(d.run("unload",null,a===d),c=o,d=a,d.run("popstate",c),t.setState(e.originalEvent.state,{animate:!1}))}}),p.route=function(e){var o=e.replace(/#.*/,""),a=s.recognize(o);if(!a)return!1;d.run("unload",null,a===d);var n=OSM.parseHash(e);return t.setState(n),window.history.pushState(n,document.title,e),c=o,d=a,d.run("pushstate",c),!0},p.stateChange=function(t){t.center?window.history.replaceState(t,document.title,OSM.formatHash(t)):window.history.replaceState(t,document.title,window.location)}):(p.route=function(t){window.location.assign(t)},p.stateChange=function(t){t.center&&window.location.replace(OSM.formatHash(t))}),p.updateHash=function(){var e=OSM.formatHash(t);e!==u&&(u=e,p.stateChange(OSM.parseHash(e)))},p.hashUpdated=function(){var e=location.hash;if(e!==u){u=e;var o=OSM.parseHash(e);t.setState(o),p.stateChange(o,e)}},p.withoutMoveListener=function(e){function o(){t.off("moveend",p.updateHash),t.once("moveend",function(){t.on("moveend",p.updateHash)})}t.once("movestart",o),e(),t.off("movestart",o)},p.load=function(){var t=d.run("load",c);p.stateChange(t||{})},p.setCurrentPath=function(t){c=t,d=s.recognize(c)},t.on("moveend baselayerchange overlaylayerchange",p.updateHash),$(window).on("hashchange",p.hashUpdated),p};